tinymce.PluginManager.add('gallery', function(editor, url) {
  function insert_or_replace(content) {
    editor.focus();
    if (editor.selection) editor.selection.setContent(content);
    else editor.insertContent(content);
  }

  function buildListItems(inputList, itemCallback, startItems) {
    function appendItems(values, output) {
      output = output || [];

      tinymce.each(values, function(item) {
        var menuItem = { text: item.text || item.title, value: '' };
        itemCallback(menuItem, item);
        output.push(menuItem);
      });

      return output;
    }

    return appendItems(inputList, startItems || []);
  }

  function ajax(cb) {
    return function() {
      editor.setProgressState(1); // Show progress
      tinymce.util.XHR.send({
        url: '/admin/galleries/getAll',
        success: function(res) {
          editor.setProgressState(0); // Hide progress
          cb(!!res ? tinymce.util.JSON.parse(res) : res);
        }
      });
    };
  }

  function popup(data) {
    var listBox,
      win = editor.windowManager.open({
        title: 'Gallery',
        width: 400,
        height: 100,
        body: [
          {
            type: 'listbox',
            name: 'my_control',
            label: 'Insert',
            tooltip: 'Select item',
            values: buildListItems(data, function(item, datum) {
              item.value = datum;
              item.text = datum.name;
            }),
            onPostRender: function() {
              listBox = this;
            }
          }
        ],
        buttons: [
          {
            text: 'Insert',
            subtype: 'primary',
            onclick: function() {
              var selected = listBox.value();
              if (!!selected)
                // insert_or_replace(
                //   '<gallery id="' +
                //     selected.id +
                //     '" style="width: 100%; height: 50px; border: 1px solid red; backgound: url(' +
                //     url +
                //     '/pictures.png)" />Gallery</gallery>'
                // );
                editor.insertContent(
                  '<gallery class="mceNonEditable" style="width:95%; margin:5px auto; display:block; height:20px; padding: 5px; color: #FFFFFF; text-align:center; background: #0096F3;" id="' +
                    selected.id +
                    '">GALLERY: <a style="color:#FFFFFF;" href="/admin/galleries/' +
                    selected.id +
                    '/edit">' +
                    selected.name +
                    '</a></gallery>'
                );
              //insert_or_replace('[gallery type="'+selected.type+'" id="' + selected.id + '" title="' + selected.title + '" gallery]')
              win.close();
            }
          },
          { text: 'Cancel', onclick: 'close' }
        ]
      });
  }

  editor.addButton('gallery', {
    tooltip: 'Select gallery',
    image: url + '/gallery.png',
    onclick: ajax(popup)
    // onclick: function () {
    //     // getGalleries();
    // }
  });
});
